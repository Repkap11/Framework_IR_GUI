FROM ubuntu:24.04

RUN apt-get update && apt-get install -y \
    designer-qt6 \
    libxcb-cursor0 \
    libusb-1.0-0 \
    make \
    python3 \
    python3-pip \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/six15/

COPY ./requirements.txt requirements.txt
RUN sed -i -s 's#lib_six15_api @ git+ssh://git@#lib_six15_api @ git+https://${GITLAB_USER_NAME}:${CI_JOB_TOKEN}@#' requirements.txt

ARG gitlab_user_name
ENV GITLAB_USER_NAME=${gitlab_user_name}

ARG ci_job_token
ENV CI_JOB_TOKEN=${ci_job_token}

# ALlow pip to install packages to the system (thats why we're running inside docker)
RUN pip install -r requirements.txt --break-system-packages

# Create a user for six15
ARG user_id
#RUN adduser --disabled-password --gecos "" --uid $user_id six15

# 23.10 already has a ubuntu user, so just rename it.
RUN usermod --login six15 --uid $user_id ubuntu
USER six15


WORKDIR /home/six15/594_gui

CMD pyinstaller --onefile --distpath out --add-data "src/icon.ico:." src/594_gui.py
