FROM tobix/pywine:3.12

RUN apt-get update && apt-get install -y \
    designer-qt6 \
    libxcb-cursor0 \
    libusb-1.0-0 \
    make \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/six15/

RUN curl -L https://github.com/git-for-windows/git/releases/download/v2.46.0.windows.1/MinGit-2.46.0-64-bit.zip --output MinGit.zip
RUN unzip MinGit.zip -d mingit
RUN cp mingit/cmd/* ${WINEPREFIX}/drive_c/windows/system32/
RUN cp mingit/mingw64/bin/* ${WINEPREFIX}/drive_c/windows/system32/

COPY ./requirements.txt requirements.txt
RUN sed -i -s 's#lib_six15_api @ git+ssh://git@#lib_six15_api @ git+https://${GITLAB_USER_NAME}:${CI_JOB_TOKEN}@#' requirements.txt

ARG gitlab_user_name
ENV GITLAB_USER_NAME=$gitlab_user_name

ARG ci_job_token
ENV CI_JOB_TOKEN=$ci_job_token
RUN wine pip install -r requirements.txt

ARG user_id
RUN adduser --disabled-password --gecos "" --uid $user_id six15
USER six15


WORKDIR /home/six15/594_gui

CMD . /opt/mkuserwineprefix ; wine pyinstaller.exe --upx-exclude=python3.dll --upx-exclude=python312.dll --onefile --noconsole --distpath out --icon src/icon.ico --add-binary "src\libusb-1.0.dll;." --add-data "src\icon.ico;." --add-data "C:\Python\Lib\site-packages\PySide6\plugins\platforms:PySide6\plugins\platforms" src/594_gui.py